---
title: "R Notebook"
output:
  html_document:
    df_print: paged
params:
  psms: ~/git/elfragmentador-data/ef_evaluation/Arabidopsis.csv.csv
  scan_metadata: ~/git/elfragmentador-data/raw_scan_metadata/RV-Col_DEX_XIII_5-A.csv
  out_prosit_in: ~/git/elfragmentador-data/ef_evaluation_prosit/Input_Arabidopsis.csv
  out_psms_prosit_filtered: ~/git/elfragmentador-data/ef_evaluation_prosit/Comparisson_Arabidopsis.csv
---

```{r, setup, include=FALSE}
# set this option in the first code chunk in the document
knitr::opts_chunk$set(echo = params$printcode)
```

```{r}

print(params)
library(tidyverse)
library(hexbin)
theme_set(theme_bw())
```

```{r}
df <- readr::read_csv(params$psms) %>% mutate(RawFile = gsub("^(.*)_[0-9]+_[0-9]+_[0-9]+", "\\1", SpecId))

scan_metadata_files <- unlist(strsplit(params$scan_metadata, split="\\s+"), use.names = FALSE)
scan_metadata <- bind_rows(purrr::map(scan_metadata_files, readr::read_csv))

df <- left_join(df, scan_metadata, by = c("RawFile" = "SpecId", "ScanNr" = "ScanNr"))

head(df)
```
```{r}
df <- df %>% 
    mutate(StripPeptide = gsub("\\[.{7}\\]", "", Peptide)) %>%
    mutate_at(vars(matches("loss|irt")), function(x) {as.numeric(gsub("\\[|\\]", "", x))})

df$PepLength <- nchar(df$StripPeptide) - 4

head(df)
```

```{r}
prosit_input_df <- df %>% 
  mutate(
    charge = as.numeric(gsub("^.*_[0-9]+_([0-9]+)_[0-9]+", "\\1", SpecId)),
    sequence = gsub("M\\[15.9949\\]", "M(ox)", gsub("(^[A-Z-]{0,3}\\.)|(\\.[A-Z-]{0,3}$)", "",Peptide))) %>% 
  filter(!grepl("\\[", sequence))


prosit_in <- prosit_input_df %>% select(
  modified_sequence = sequence,
  collision_energy = CollisionEnergy,
  precursor_charge=charge)


dir.create(dirname(params$out_prosit_in), recursive = TRUE) 

readr::write_csv(file = params$out_prosit_in, x = prosit_in) 
readr::write_csv(file = params$out_psms_prosit_filtered, x = prosit_input_df)

system(paste("head -10 ", params$out_prosit_in))

system(paste("head -2 ", params$out_psms_prosit_filtered))

```



```{r}
unique_modifications <- grep("\\[.*\\]", df$Peptide, value = TRUE, perl = TRUE) %>%
    gsub(".*(\\[.*?\\]).*", "\\1", .) %>% 
    unique() %>% 
    gsub("\\[", "\\\\\\[", .) %>%
    gsub("\\]", "\\\\\\]", .)

unique_modifications
```


```{r}
for (mod in unique_modifications) {
    g <- ggplot(df, aes(x = RetentionTime, y = Prediction_irt, colour = grepl(mod, Peptide))) + geom_point(shape = ".")
    g <- g + ggtitle(mod)
    print(g)
}
mod

for (mod in unique_modifications) {
  tmp_df <- df %>% group_by(Peptide) %>% top_n(1, `mokapot score`)

  g <- ggplot(tmp_df, aes(x = RetentionTime, y = Prediction_irt, colour = grepl(mod, Peptide))) +
    geom_point(size=1, alpha=0.1)
  g <- g + ggtitle(mod)
  print(g)
}

```

```{r}
df$residual_irt <- predict(lm(Prediction_irt ~ RetentionTime, data=df), newdata = df) - df$Prediction_irt

top_residuals <- df %>%
    top_n(200, abs(residual_irt)) %>% 
    group_by(Peptide) %>% 
    top_n(1, abs(residual_irt)) %>% 
    ungroup() %>% 
    top_n(10, abs(residual_irt))

for (mod in unique_modifications) {
    g <- ggplot(df, aes(x = RetentionTime, y = Prediction_irt, colour = grepl(mod, Peptide))) + geom_point(shape = ".")
    g <- g + ggrepel::geom_text_repel(
        data = top_residuals, 
        colour = "black",
        aes(label = Peptide),
        min.segment.length = 0,
        max.iter = 2000,
        force = 300,
        max.overlaps = 20)
    g <- g + ggtitle(mod)
    print(g)
}
mod

top_residuals <- df %>%
    top_n(200, abs(residual_irt)) %>% 
    group_by(Peptide) %>% 
    top_n(1, abs(residual_irt)) %>% 
    ungroup() %>% 
    top_n(10, abs(residual_irt))

for (pep in top_residuals$Peptide) {
    weird_peptide <- filter(df, Peptide == pep)
    
    g <- ggplot(df, aes(x = RetentionTime, y = Prediction_irt)) + 
        geom_point(shape = ".") + 
        geom_point(data = weird_peptide)
    g <- g + ggtitle(pep)
    print(g)
}


```


```{r fig.height=4, fig.width=16}
 tmp_df <- df %>%
        filter(PepLength < 35) %>%
        mutate(PepLength = factor(PepLength)) %>%
        group_by(PepLength) %>%
        mutate(n = n()) %>%
        filter(n > 20) %>%
        ungroup()
    
for (mod in unique_modifications) {
    tmp_df2 <- mutate(tmp_df, ModifiedPeptide = grepl(mod, Peptide))
    count_df <- tmp_df2 %>% 
        group_by(PepLength, ModifiedPeptide) %>%
        summarise(n = n()) %>%
        ungroup()
        
    
    g <- tmp_df2 %>%
        ggplot(aes(x = PepLength, y = 1 -Loss_loss_angle, colour = ModifiedPeptide)) +
        geom_boxplot(alpha=0.8, outlier.size = 0.5, outlier.alpha = 0.5) +
        geom_text(
            alpha = 1, data = count_df, y = 0.05,
            aes(label = n, colour = ModifiedPeptide), position = position_dodge2(width=0.9, padding = 0.02))
    g <- g + ggtitle(mod) + ylim(0,1)
    print(g)
}


for (mod in unique_modifications) {
    tmp_df3 <- mutate(tmp_df, ModifiedPeptide = grepl(mod, Peptide)) %>%
      group_by(Peptide) %>%
      top_n(1, `mokapot score`)
    
    count_df <- tmp_df2 %>%
      group_by(Peptide) %>%
      top_n(1, `mokapot score`) %>% 
      group_by(PepLength, ModifiedPeptide) %>%
      summarise(n = n()) %>%
      ungroup()
        
    
    g <- tmp_df2 %>%
        ggplot(aes(x = PepLength, y = 1 -Loss_loss_angle, fill = ModifiedPeptide)) +
        geom_boxplot(alpha=0.8, outlier.size = 0.5, outlier.alpha = 0.5) +
        geom_text(
            alpha = 1, data = count_df, y = 0.05,
            aes(label = n, colour = ModifiedPeptide), position = position_dodge2(width=0.9, padding = 0.02))
    g <- g + ggtitle(mod) + ylim(0,1)
    print(g)
}
mod


```


```{r}
```

